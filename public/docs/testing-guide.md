# テスト機能ガイド

このドキュメントでは、OpenFisca Editorでのテスト機能の使い方と効果的なテストケース作成の方法について説明します。

## 目次

- [テストの重要性](#テストの重要性)
- [テストケースパネルの概要](#テストケースパネルの概要)
- [テストケースの作成](#テストケースの作成)
- [テストの実行](#テストの実行)
- [テスト結果の解釈](#テスト結果の解釈)
- [YAMLテストファイル](#yamlテストファイル)
- [効果的なテスト戦略](#効果的なテスト戦略)
- [テストとバージョン管理の連携](#テストとバージョン管理の連携)
- [トラブルシューティング](#トラブルシューティング)

## テストの重要性

OpenFiscaでの制度モデリングにおいて、テストは以下の理由で非常に重要です：

1. **正確性の検証**: 制度が想定通りに動作することを確認
2. **エッジケースの確認**: 極端なケースでも正しく動作するか確認
3. **変更の影響検証**: 変更が既存機能に悪影響を与えていないかを確認
4. **ドキュメントの役割**: テストケースが制度の使用方法の例として機能

制度が複雑になるほど、テストの重要性は増します。十分なテストを行わずに制度をリリースすると、予期せぬ結果を招く可能性があります。

## テストケースパネルの概要

テストケースパネルは、選択した制度のテストケースを管理するためのインターフェースです。このパネルでは以下の操作が可能です：

- テストケースの作成
- 既存テストケースの編集
- テストケースの削除
- テストの実行
- テスト結果の確認

テストケースパネルは「テストケース」タブから利用できます。

## テストケースの作成

### 基本的なテストケースの作成

1. 「テストケース」タブを選択します。
2. 「新しいテストケースを追加」ボタンをクリックします。
3. テストケース作成モーダルが表示されます。
4. 以下の情報を入力します：
   - **テスト名**: テストケースの名前
   - **期間**: テストを実行する日付（例：2023-01-01）
   - **世帯構成**:
     - 親の年齢（複数可）
     - 祖父母の年齢（複数可）
     - 子供の年齢（複数可）
   - **期待される結果**: 期待される給付金額など
5. 「保存」ボタンをクリックします。

### アドバンスドモード

より複雑なテストケースを作成する場合は、アドバンスドモードを使用できます：

1. テストケース作成モーダルで「アドバンスドモード」を選択します。
2. YAMLエディタが表示されます。
3. 以下のようなYAML形式でテストケースを定義します：

```yaml
- name: ケース1 - 3歳未満の子供1人
  period: 2023-01-01
  input:
    世帯:
      親一覧:
        - 35
      子一覧:
        - 2
      世帯収入: 6000000
  output:
    世帯:
      児童手当: 15000
```

4. 「保存」ボタンをクリックします。

## テストの実行

テストを実行するには、以下の手順を実行します：

1. 「テストケース」タブで「テスト実行」ボタンをクリックします。
2. テストが実行され、結果が表示されます。
3. テスト実行ダイアログに以下の情報が表示されます：
   - 成功したテスト数
   - 失敗したテスト数
   - 実行時間
   - 詳細な結果（テストケースごとの結果）

テスト実行は、制度を保存する際やコミットする前に自動的に実行されることもあります。

### テスト実行の仕組み

OpenFisca Editorのテスト実行は以下の仕組みで動作しています：

1. **APIベースの実行**: 通常、テストはOpenFiscaバックエンドAPIを通じて実行されます
2. **フォールバックモード**: バックエンドに接続できない場合は、モックデータを使用して近似的なテスト結果を表示します
3. **自動再試行**: 接続エラーが発生した場合、自動的にフォールバックモードに切り替わります

テストの実装は`lib/test-runner.ts`にあり、APIへの接続とフォールバック処理を担当しています。

### テスト実行のショートカット

テスト実行には以下のショートカットキーが利用できます：
- `Ctrl+Enter` (Windows/Linux) または `Cmd+Enter` (Mac)

## テスト結果の解釈

テスト結果モーダルでは、以下の情報が表示されます：

- **成功・失敗の概要**: 合計テスト数、成功数、失敗数
- **テストケースごとの結果**:
  - ✅ 成功: 期待される結果と実際の結果が一致
  - ❌ 失敗: 期待される結果と実際の結果が不一致

失敗したテストについては、以下の情報が表示されます：

- 期待される結果
- 実際の結果
- 差分

この情報をもとに、制度のコードを修正して再度テストを実行します。

## YAMLテストファイル

OpenFiscaのテストは、YAMLファイル形式で定義されます。テストYAMLファイルの基本構造は以下の通りです：

```yaml
# テストファイルのコメント（制度名や参照URLなど）

- name: テストケース1の名前
  period: テスト対象期間（YYYY-MM-DD形式）
  input:
    エンティティ名:
      属性1: 値
      属性2: 値
      子一覧:
        - 値1
        - 値2
  output:
    エンティティ名:
      変数名: 期待される値

- name: テストケース2の名前
  period: テスト対象期間
  input:
    # 入力データ
  output:
    # 期待される出力
```

### 入力データの例

```yaml
input:
  世帯:
    親一覧:
      - 35  # 35歳の親
      - 36  # 36歳の親
    子一覧:
      - 5   # 5歳の子供
      - 8   # 8歳の子供
    世帯収入: 6000000  # 年収600万円
```

### 出力データの例

```yaml
output:
  世帯:
    児童手当: 20000  # 児童手当の給付額20,000円を期待
```

## 効果的なテスト戦略

効果的なテストケースを作成するためのベストプラクティス：

1. **境界値テスト**: 条件の境界値でテストする
   - 例: 3歳ちょうど、15歳ちょうど（児童手当の年齢条件）

2. **エッジケースのテスト**: 極端なケースでテストする
   - 例: 子供なし、多数の子供、最大・最小年齢

3. **典型的なケースのテスト**: 一般的な状況をテストする
   - 例: 標準的な家族構成、平均的な収入

4. **変更ごとのテスト**: 制度に変更を加えるたびに新しいテストを追加

5. **全パターンの網羅**: 可能な限り多くのパターンをテストする
   - 例: 異なる年齢層、収入レベルの組み合わせ

## テストとバージョン管理の連携

テストはバージョン管理システムと連携しています：

1. **コミット時のテスト**: 制度をコミットすると、自動的にテストが実行されます。
2. **テスト結果の保存**: テスト結果はバージョンごとに保存され、履歴として確認できます。
3. **テスト失敗の表示**: バージョン履歴で、テストが失敗したコミットは警告アイコンで表示されます。

テスト失敗時には、そのバージョンに問題があることを示しています。テストが成功するまでコードを修正し、新しいコミットを作成することをお勧めします。

## トラブルシューティング

### テスト実行時のエラー

- **期間フォーマットエラー**: テストケースの期間が正しい形式（YYYY-MM-DD）であるか確認
- **変数名エラー**: テストケースで参照している変数名がコードで定義されているか確認
- **ロジックエラー**: 計算ロジックに間違いがないか確認

### よくあるテスト失敗の原因

1. **端数処理の違い**: 小数点以下の端数処理方法が異なる（切り捨て／切り上げ／四捨五入）
2. **日付の解釈**: 期間の解釈に誤りがある（月末／月初など）
3. **条件判断のミス**: 条件式の論理に問題がある（AND/ORの混同など）
4. **パラメータの変更**: パラメータが更新されたが、テストケースが更新されていない

### 解決方法

1. 失敗したテストの詳細な差分を確認
2. テストケースの入力値と期待値を確認
3. 制度のコードでの計算ロジックを確認
4. 同様のテストケースが成功している場合は、それとの違いを分析

## ベストプラクティス：テストケースの例

### 児童手当の例

```yaml
# 児童手当のテスト
# 参照URL: https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kodomo/kodomo_kosodate/jidouteate/index.html

- name: ケース1 - 3歳未満の子供1人
  period: 2023-01-01
  input:
    世帯:
      親一覧:
        - 35
      子一覧:
        - 2
  output:
    世帯:
      児童手当: 15000

- name: ケース2 - 小学生の子供2人
  period: 2023-01-01
  input:
    世帯:
      親一覧:
        - 40
      子一覧:
        - 5
        - 8
  output:
    世帯:
      児童手当: 20000

- name: ケース3 - 中学生の子供1人
  period: 2023-01-01
  input:
    世帯:
      親一覧:
        - 45
      子一覧:
        - 13
  output:
    世帯:
      児童手当: 10000

- name: ケース4 - 高校生の子供1人（対象外）
  period: 2023-01-01
  input:
    世帯:
      親一覧:
        - 50
      子一覧:
        - 16
  output:
    世帯:
      児童手当: 0
```

このように、異なる年齢層や家族構成のパターンをテストケースに含めることで、制度が様々な状況で正しく機能することを確認できます。
